---
title: "Dog Jealousy- analysis Script"
author: "CV"
date: "September 22, 2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

rm(list=ls())


library(lme4)
library(MASS) # negative binomial tests
library(ggthemes)
library(psych)
library(cowplot)
library(glmmTMB)
library(eeptools)
library(car)


#install.packages("")

#load(file ="mm1_mult_poss.RData")

library(exactRankTests)
library(tidyverse)
library(summarytools)
better.wilcox2=function(var1, var2){
  test.data=data.frame(var1, var2)
  test.data=subset( test.data, var1 != var2)
  N=nrow(test.data)
  w.res=wilcox.exact (test.data$var1, test.data$var2, paired=T, exact=T, alternative = c("two.sided"))
  wT=w.res$statistic
  wT=max(c(wT, N*(N+1)/2- wT))
return(data.frame(T.plus=wT, N=N, P=w.res$p.value) )
}

source("./functions/diagnostic_fcns.r")
source("./functions/glmm_stability.r")
source("./functions/boot_glmm.r")
source("./functions/drop1_para.r")

```

Notes:
Maylo is doubled. Dusty has no values in reaction phase.--> already fixed

Load raw data
```{r loading data, include = FALSE}
orig.data <- read.csv(file="data/201002_behavioural test_coding_data_all_dogs_new.csv")

orig.data$test_date <- paste(orig.data$year, orig.data$month, orig.data$day,sep="-")

orig.data$test_date <- as.Date(orig.data$test_date)
orig.data$birthdate <- as.Date(orig.data$birthdate, "%d.%m.%Y")

orig.data$age <- floor(age_calc(orig.data$birthdate, orig.data$test_date, units = "months"))

view(dfSummary(orig.data))
```

Aggregate data
```{r loading data, include = FALSE}
agg.data<-orig.data %>%
  mutate(blocking = ifelse(Value=="Blocking",1,0), non_off_manipulation = ifelse(Value=="Non-offensive manipulation",1,0), dom_beh = ifelse(Value=="Dominant behaviours",1,0), interaction_dog = ifelse(Value=="Interaction with fake dog",1,0), first_dog_approach = ifelse(Behaviour=="First approach" & Value=="Approach fake dog",1,0), sniffing_dog = ifelse(Value=="Sniffing fake dog" | Value=="Sniffing anal region of fake dog",1,0)) %>%
  group_by(subject, breed, age, sex, condition, side_fakedog, side_chair) %>%
  summarise(blocking.sum=sum(blocking), non.off.manipulation.sum=sum(non_off_manipulation), dom.beh.sum=sum(dom_beh), interaction.dog.sum=sum(interaction_dog), dog.approach.sum=sum(first_dog_approach), sniffing.dog.sum=sum(sniffing_dog))%>%
  mutate(blocking.presence = ifelse(blocking.sum>0,1,0), non.off.manipulation.presence = ifelse(non.off.manipulation.sum>0,1,0), dom.beh.presence = ifelse(dom.beh.sum>0,1,0), interaction.dog.presence = ifelse(interaction.dog.sum>0,1,0), sniffing.dog.presence = ifelse(sniffing.dog.sum>0,1,0)) %>%
  ungroup()

agg.data$human <- as.factor(substring(agg.data$condition, 1,1))
agg.data$treatment <- as.factor(substring(agg.data$condition, 2,2))

view(dfSummary(agg.data))



hist(agg.data$blocking.sum)
hist(agg.data$non.off.manipulation.sum)
hist(agg.data$dom.beh.sum)
hist(agg.data$interaction.dog.sum)
hist(agg.data$dog.approach.sum)
hist(agg.data$sniffing.dog.sum)

table(agg.data$condition, agg.data$blocking.presence)
table(agg.data$condition, agg.data$non.off.manipulation.presence)
table(agg.data$condition, agg.data$dom.beh.presence)
```

``` {r mixed modeling, error=TRUE}

# centering variables for modeling

model.data <- agg.data %>% 
  mutate(z.age = as.numeric(scale(age, scale = T, center = T)),
         sex.c = as.numeric(scale(as.numeric(sex), scale = F, center = T)))

as.data.frame(model.data)
#view(dfSummary(model.data))
```


### Blocking variable

```{r}
blocking.glm01 <- glm(blocking.presence ~ human * treatment + z.age + sex, 
             data = model.data, family = binomial)

summary(blocking.glm01)

drop1(blocking.glm01, test="Chisq")#likelihood ratio test
```

```{r}
blocking.glm02 <- glm(blocking.presence ~ human + treatment + z.age + sex, 
             data = model.data, family = binomial)

summary(blocking.glm02)

drop1(blocking.glm02, test="Chisq")#likelihood ratio test
```

#### check for colinearity in the previous model.

```{R echo=FALSE, error=FALSE, warning=FALSE}

col.blocking.glm <- lm(blocking.presence ~ human + treatment + z.age + sex, data = model.data)
vif(col.blocking.glm)
#no problem
```



#### Model stability
```{r}
cbind(coef(blocking.glm02), coef(blocking.glm02)+t(apply(X=dfbeta(blocking.glm02), MARGIN=2, FUN=range)))
```

#### Confidence intervals
```{r}
cbind(orig=coefficients(blocking.glm02), confint(object=blocking.glm02))
```

### CI for the plot

```{r}
blocking.glm02.ci <- glm(blocking.presence ~ human + treatment + z.age + sex.c, 
             data = model.data, family = binomial)
##adding fitted values
fv=rep(NA, times=4)
fv[1]=coef(blocking.glm02.ci )["(Intercept)"]
fv[2]=sum(coef(blocking.glm02.ci)[c("(Intercept)", "treatmentP")])
fv[3]=sum(coef(blocking.glm02.ci)[c("(Intercept)", "humanS")])
fv[4]=sum(coef(blocking.glm02.ci)[c("(Intercept)", "treatmentP",
"humanS")])
fv=exp(fv)/(1+exp(fv))

to.plot <- model.data %>%
  group_by(human, treatment)%>%
  summarise(mean.blocking=mean(blocking.presence))%>%
  ungroup()

to.plot$z.age=0
to.plot$sex.c=0


ci.plot=predict.glm(object=blocking.glm02.ci, newdata=to.plot,type="link", se.fit=T)


ci.plot=data.frame(
lwr=ci.plot$fit-ci.plot$se.fit*
abs(qt(p=0.025, df=blocking.glm02.ci$df.residual)),
upr=ci.plot$fit+ci.plot$se.fit*
abs(qt(p=0.025, df=blocking.glm02.ci$df.residual))
)
ci.plot=exp(ci.plot)/(1+exp(ci.plot))

to.plot=(cbind(to.plot, fv, ci.plot))

```



### plotting

```{r}

blocking.plot.data <- agg.data %>%
  mutate(human = fct_recode(human, "Caregiver" = "C", "Stranger" = "S"), treatment=fct_recode(treatment, "Vet Check"="M", "Greeting"="P"))%>% #renaming of factor levels
  group_by(condition, human, treatment)%>%
  summarise(mean.blocking=mean(blocking.presence), sd.blocking=sd(blocking.presence),  median.blocking=median(blocking.presence),  se.blocking=sd(blocking.presence)/sqrt(length(blocking.presence)))

blocking.plot.data <- cbind(as.data.frame(blocking.plot.data), fv, ci.plot)

plot.blocking <- ggplot(
  data=blocking.plot.data, aes(x=interaction(treatment, human), y=mean.blocking)) +
  geom_bar(stat="identity", alpha=0.5)+
  geom_errorbar(aes(x=interaction(treatment, human), ymin=lwr, ymax=upr), width=.2) +
  geom_point(aes(x=interaction(treatment, human), y=fv)) +
  ylim(0,1)+
  theme_classic()+
  labs(x="Condition",y="Proportion of blocking")


ggsave(plot.blocking, filename = "graphs/blocking_plot.png", width = 10, height = 6, scale = 0.6)
```


### Analysis of all blocking events (blocking.sum)

```{r}
hist(model.data$blocking.sum, breaks = c(0,1,2,3,4,5,6, 10))
```

```{r}
blocking.glm03 <- glm(blocking.sum ~ human * treatment + z.age + sex, 
             data = model.data, family = poisson)

overdisp.test(blocking.glm03)
```
--> overdispersed. Try negative binomial model instead of poisson model

```{r}


blocking.glm04=glm.nb(blocking.sum ~ human * treatment + z.age + sex, data = model.data)


overdisp.test(blocking.glm04)
--> not overdispersed

summary(blocking.glm04)

drop1(blocking.glm04, test="Chisq")#likelihood ratio test

```


```{r}
blocking.glm05=glm.nb(blocking.sum ~ human + treatment + z.age + sex, data = model.data)


overdisp.test(blocking.glm05)
--> not overdispersed

summary(blocking.glm05)

drop1(blocking.glm05, test="Chisq")#likelihood ratio test

```
--> same result as the binomial model with the blocking presence / absent DV


### Non-offensive manipulation behaviours



Notes:
Maylo is doubled. Dusty has no values in reaction phase.--> already fixed
new: there were mistakes in the birth dates of several dogs in data file --> fixed (csv file:".._new")




```{r}
non_off_manipulation.glm01 <- glm(non.off.manipulation.presence ~ human * treatment + z.age + sex, 
             data = model.data, family = binomial)

summary(non_off_manipulation.glm01)

drop1(non_off_manipulation.glm01, test="Chisq")#likelihood ratio test
```
```{r}
non_off_manipulation.glm02 <- glm(non.off.manipulation.presence ~ human + treatment + z.age + sex, 
             data = model.data, family = binomial)

summary(non_off_manipulation.glm02)

drop1(non_off_manipulation.glm02, test="Chisq")#likelihood ratio test
```

#### check for colinearity in the previous model.

```{R echo=FALSE, error=FALSE, warning=FALSE}

col.non_off_manipulation.glm <- lm(non.off.manipulation.presence ~ human + treatment + z.age + sex, data = model.data)
vif(col.non_off_manipulation.glm)
#no problem
```

#### Model stability
```{r}
cbind(coef(non_off_manipulation.glm02), coef(non_off_manipulation.glm02)+t(apply(X=dfbeta(non_off_manipulation.glm02), MARGIN=2, FUN=range)))
```

#### Confidence intervals
```{r}
cbind(orig=coefficients(non_off_manipulation.glm02), confint(object=non_off_manipulation.glm02))
```

### CI for the plot

```{r}
non_off_manipulation.glm02.ci <- glm(non.off.manipulation.presence ~ human + treatment + z.age + sex.c, 
             data = model.data, family = binomial)
##adding fitted values
fv=rep(NA, times=4)
fv[1]=coef(non_off_manipulation.glm02.ci )["(Intercept)"]
fv[2]=sum(coef(non_off_manipulation.glm02.ci)[c("(Intercept)", "treatmentP")])
fv[3]=sum(coef(non_off_manipulation.glm02.ci)[c("(Intercept)", "humanS")])
fv[4]=sum(coef(non_off_manipulation.glm02.ci)[c("(Intercept)", "treatmentP",
"humanS")])
fv=exp(fv)/(1+exp(fv))

to.plot <- model.data %>%
  group_by(human, treatment)%>%
  summarise(mean.non_off_manipulation=mean(non.off.manipulation.presence))%>%
  ungroup()

to.plot$z.age=0
to.plot$sex.c=0


ci.plot=predict.glm(object=non_off_manipulation.glm02.ci, newdata=to.plot,type="link", se.fit=T)


ci.plot=data.frame(
lwr=ci.plot$fit-ci.plot$se.fit*
abs(qt(p=0.025, df=non_off_manipulation.glm02.ci$df.residual)),
upr=ci.plot$fit+ci.plot$se.fit*
abs(qt(p=0.025, df=non_off_manipulation.glm02.ci$df.residual))
)
ci.plot=exp(ci.plot)/(1+exp(ci.plot))

to.plot=(cbind(to.plot, fv, ci.plot))

```



### plotting

```{r}

non_off_manipulation.plot.data <- model.data %>%
  mutate(human = fct_recode(human, "Caregiver" = "C", "Stranger" = "S"), treatment=fct_recode(treatment, "Vet Check"="M", "Greeting"="P"))%>% #renaming of factor levels
  group_by(condition, human, treatment)%>%
  summarise(mean.non_off_manipulation=mean(non.off.manipulation.presence), sd.non_off_manipulation=sd(non.off.manipulation.presence),  median.non_off_manipulation=median(non.off.manipulation.presence),  se.non_off_manipulation=sd(non.off.manipulation.presence)/sqrt(length(non.off.manipulation.presence)))

non_off_manipulation.plot.data <- cbind(as.data.frame(non_off_manipulation.plot.data), fv, ci.plot)

plot.non_off_manipulation <- ggplot(
  data=non_off_manipulation.plot.data, aes(x=interaction(treatment, human), y=mean.non_off_manipulation)) +
  geom_bar(stat="identity", alpha=0.5)+
  geom_errorbar(aes(x=interaction(treatment, human), ymin=lwr, ymax=upr), width=.2) +
  geom_point(aes(x=interaction(treatment, human), y=fv)) +
  ylim(0,1)+
  theme_classic()+
  labs(x="Condition",y="Proportion of non-offensive manipulation")


ggsave(plot.non_off_manipulation, filename = "graphs/non_off_manipulation_plot.png", width = 10, height = 6, scale = 0.6) # not running yet due to new csv file
```


###Dominant behaviours



```{r}
dom_beh.glm01 <- glm(dom.beh.presence ~ human * treatment + z.age + sex, 
             data = model.data, family = binomial)

summary(dom_beh.glm01)

drop1(dom_beh.glm01, test="Chisq")#likelihood ratio test
```

```{r}
dom_beh.glm02 <- glm(dom.beh.presence ~ human + treatment + z.age + sex, 
             data = model.data, family = binomial)

summary(dom_beh.glm02)

drop1(dom_beh.glm02, test="Chisq")#likelihood ratio test
```

#### check for colinearity in the previous model.

```{R echo=FALSE, error=FALSE, warning=FALSE}

col.dom_beh.glm <- lm(dom.beh.presence ~ human + treatment + z.age + sex, data = model.data)
vif(col.dom_beh.glm)
#no problem
```

#### Model stability
```{r}
cbind(coef(dom_beh.glm02),coef(dom_beh.glm02)+t(apply(X=dfbeta(dom_beh.glm02), MARGIN=2, FUN=range)))
```

#### Confidence intervals
```{r}
cbind(orig=coefficients(dom_beh.glm02), confint(object=dom_beh.glm02))
```

### CI for the plot

```{r}
dom_beh.glm02.ci <- glm(dom.beh.presence ~ human + treatment + z.age + sex.c, 
             data = model.data, family = binomial)
##adding fitted values
fv=rep(NA, times=4)
fv[1]=coef(dom_beh.glm02.ci )["(Intercept)"]
fv[2]=sum(coef(dom_beh.glm02.ci)[c("(Intercept)", "treatmentP")])
fv[3]=sum(coef(dom_beh.glm02.ci)[c("(Intercept)", "humanS")])
fv[4]=sum(coef(dom_beh.glm02.ci)[c("(Intercept)", "treatmentP",
"humanS")])
fv=exp(fv)/(1+exp(fv))

to.plot <- model.data %>%
  group_by(human, treatment)%>%
  summarise(mean.dom_beh=mean(dom.beh.presence))%>%
  ungroup()

to.plot$z.age=0
to.plot$sex.c=0


ci.plot=predict.glm(object=dom_beh.glm02.ci, newdata=to.plot,type="link", se.fit=T)


ci.plot=data.frame(
lwr=ci.plot$fit-ci.plot$se.fit*
abs(qt(p=0.025, df=dom_beh.glm02.ci$df.residual)),
upr=ci.plot$fit+ci.plot$se.fit*
abs(qt(p=0.025, df=dom_beh.glm02.ci$df.residual))
)
ci.plot=exp(ci.plot)/(1+exp(ci.plot))

to.plot=(cbind(to.plot, fv, ci.plot))

```



### plotting

```{r}

dom_beh.plot.data <- model.data %>%
  mutate(human = fct_recode(human, "Caregiver" = "C", "Stranger" = "S"), treatment=fct_recode(treatment, "Vet Check"="M", "Greeting"="P"))%>% #renaming of factor levels
  group_by(condition, human, treatment)%>%
  summarise(mean.dom_beh=mean(dom.beh.presence), sd.dom_beh=sd(dom.beh.presence),  median.dom_beh=median(dom.beh.presence),  se.dom_beh=sd(dom.beh.presence)/sqrt(length(dom.beh.presence)))

dom_beh.plot.data <- cbind(as.data.frame(dom_beh.plot.data), fv, ci.plot)

plot.dom_beh <- ggplot(
  data=dom_beh.plot.data, aes(x=interaction(treatment, human), y=mean.dom_beh)) +
  geom_bar(stat="identity", alpha=0.5)+
  geom_errorbar(aes(x=interaction(treatment, human), ymin=lwr, ymax=upr), width=.2) +
  geom_point(aes(x=interaction(treatment, human), y=fv)) +
  ylim(0,1)+
  theme_classic()+
  labs(x="Condition",y="Proportion of dominant behaviours")


ggsave(plot.blocking, filename = "graphs/dom_beh_plot.png", width = 10, height = 6, scale = 0.6) # not running yet due to new csv file
```


